---
import Layout from '../layouts/Layout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import ContactButton from '../components/buttons/ContactButton.astro';
import PageHero from '../components/PageHero.astro';
import { getCollection } from 'astro:content';
import { PROJECT_CATEGORIES } from '../consts';

const projectsRaw = await getCollection('projects');
const sortedProjects = projectsRaw.sort((a, b) => a.data.order - b.data.order);
---

<Layout 
  title="Our Projects | GBRS Services | Construction Portfolio"
  description="View 120+ completed construction projects by GBRS Services. Agricultural buildings, industrial structures, and steel erection projects across Hartlepool and North East UK."
  activePage="projects"
>
  <PageHero 
    title="Our Projects" 
    subtitle="120+ Completed Projects Across the North East" 
  />

  <section class="projects section">
    <div class="container">
      <div class="projects-filter">
        <label for="category-filter">Filter by:</label>
        <select id="category-filter" class="filter-select">
          <option value="all">All Projects</option>
          {Object.entries(PROJECT_CATEGORIES).map(([key, label]) => (
            <option value={key}>{label}</option>
          ))}
        </select>
        
        <div class="project-count">
          Showing <span id="showing-count">12</span> of <span id="total-count">120</span> projects
        </div>
      </div>
      
      <div class="projects-grid-enhanced" id="projects-grid">
        {sortedProjects.map(project => (
          <ProjectCard project={project} />
        ))}

        <div class="project-card placeholder-card" style="grid-column: 1 / -1; background: var(--light-grey); text-align: center; padding: 60px 20px;">
          <h3 style="margin-bottom: 15px; color: #333;">Portfolio Update in Progress</h3>
          <p style="margin-bottom: 25px; color: #666; max-width: 700px; margin-left: auto; margin-right: auto;">
            We're currently uploading our complete portfolio of 120+ projects including agricultural buildings, 
            industrial warehouses, groundworks, and steel erection projects across Hartlepool and the North East. 
            Check back soon for our full gallery, or contact us to discuss your project.
          </p>
          <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <ContactButton/>
          </div>
          <p style="margin-top: 30px; color: #666;">
            <a href="https://www.facebook.com/profile.php?id=100089807464669" target="_blank" rel="noopener noreferrer" class="fb-link">
              Follow us on Facebook for regular project updates →
            </a>
          </p>
        </div>
      </div>

      <div class="pagination" id="pagination">
        <button class="pagination-btn" id="prev-btn" disabled>← Previous</button>
        <div class="pagination-numbers" id="pagination-numbers"></div>
        <button class="pagination-btn" id="next-btn">Next →</button>
      </div>
    </div>
  </section>


  <script is:inline>
    // Pagination and Filtering Logic
    let currentPage = 1;
    const projectsPerPage = 12;
    const projectCards = Array.from(document.querySelectorAll('.project-card:not(.placeholder-card)'));
    const totalProjects = projectCards.length; 
    
    const totalVisibleProjects = projectCards.length;
    const totalPages = Math.ceil(totalVisibleProjects / projectsPerPage);

    const categoryFilter = document.getElementById('category-filter');
    const showingCount = document.getElementById('showing-count');
    const totalCount = document.getElementById('total-count');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const paginationNumbers = document.getElementById('pagination-numbers');

    // Initial update of counts
    if (totalCount) totalCount.textContent = totalVisibleProjects + "+"; 

    function updatePagination() {
      const selectedCategory = categoryFilter ? categoryFilter.value : 'all';
      const visibleCards = projectCards.filter(card => {
        return selectedCategory === 'all' || card.dataset.category === selectedCategory;
      });

      const pageCount = Math.ceil(visibleCards.length / projectsPerPage);
      if (currentPage > pageCount) currentPage = 1;
      
      // Hide all first
      projectCards.forEach(card => card.style.display = 'none');

      // Show current page of filtered items
      const start = (currentPage - 1) * projectsPerPage;
      const end = start + projectsPerPage;
      const pageItems = visibleCards.slice(start, end);
      
      pageItems.forEach(card => card.style.display = '');

      // Update UI
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === pageCount || pageCount === 0;
      
      if (showingCount) showingCount.textContent = pageItems.length;
      
      renderPaginationNumbers(pageCount);
    }

    function renderPaginationNumbers(count) {
      if (!paginationNumbers) return;
      paginationNumbers.innerHTML = '';
      
      for (let i = 1; i <= count; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-number';
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.addEventListener('click', () => {
          currentPage = i;
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        paginationNumbers.appendChild(btn);
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const selectedCategory = categoryFilter ? categoryFilter.value : 'all';
        const visibleCards = projectCards.filter(card => {
           return selectedCategory === 'all' || card.dataset.category === selectedCategory;
        });
        const pageCount = Math.ceil(visibleCards.length / projectsPerPage);

        if (currentPage < pageCount) {
          currentPage++;
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    if (categoryFilter) {
      categoryFilter.addEventListener('change', () => {
        currentPage = 1;
        updatePagination();
      });
    }

    updatePagination();
  </script>
</Layout>
