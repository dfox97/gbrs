---
// Project Gallery Modal Component
---

<div id="projectLightbox" class="project-modal" role="dialog" aria-modal="true" aria-labelledby="lightboxTitle" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" type="button" aria-label="Close gallery">&times;</button>
    <h3 id="lightboxTitle" class="modal-title"></h3>

    <div class="modal-gallery" aria-live="polite">
      <div class="modal-track" style="transform: translate3d(0, 0, 0);">
        <!-- Slides injected by JS -->
      </div>

      <button class="modal-prev" type="button" aria-label="Previous image">
        <span aria-hidden="true">‹</span>
      </button>
      <button class="modal-next" type="button" aria-label="Next image">
        <span aria-hidden="true">›</span>
      </button>

      <div class="modal-ui" aria-hidden="true">
        <span class="modal-counter"></span>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  const modal = document.getElementById('projectLightbox');
  const modalTitle = document.getElementById('lightboxTitle');
  const modalTrack = document.querySelector('#projectLightbox .modal-track');
  const modalCounter = document.querySelector('#projectLightbox .modal-counter');
  const modalClose = document.querySelector('#projectLightbox .modal-close');
  const modalPrev = document.querySelector('#projectLightbox .modal-prev');
  const modalNext = document.querySelector('#projectLightbox .modal-next');

  let currentProjectTitle = '';
  let images = [];
  let currentImageIndex = 0;
  let lastFocusedEl = null;

  function isOpen() {
    return !!(modal && modal.classList.contains('active'));
  }

  function clampIndex(index) {
    if (!images.length) return 0;
    return Math.max(0, Math.min(index, images.length - 1));
  }

  function setButtonsDisabled() {
    if (modalPrev instanceof HTMLButtonElement) modalPrev.disabled = currentImageIndex <= 0;
    if (modalNext instanceof HTMLButtonElement) modalNext.disabled = currentImageIndex >= images.length - 1;
  }

  function updateCounter() {
    if (modalCounter) {
      modalCounter.textContent = images.length ? `${currentImageIndex + 1} / ${images.length}` : '';
    }
  }

  function updateTitle() {
    if (modalTitle) modalTitle.textContent = currentProjectTitle || '';
  }

  function updateTrackTransform({ animate = true } = {}) {
    if (!(modalTrack instanceof HTMLElement)) return;

    if (!animate) modalTrack.classList.add('no-anim');

    const translatePct = currentImageIndex * -100;
    modalTrack.style.transform = `translate3d(${translatePct}%, 0, 0)`;

    if (!animate) {
      void modalTrack.offsetHeight;
      modalTrack.classList.remove('no-anim');
    }
  }

  function buildSlides() {
    if (!(modalTrack instanceof HTMLElement)) return;
    modalTrack.innerHTML = '';

    const fragment = document.createDocumentFragment();
    images.forEach((src, index) => {
      const slide = document.createElement('div');
      slide.className = 'modal-slide';

      const img = document.createElement('img');
      img.src = src;
      img.alt = currentProjectTitle ? `${currentProjectTitle} - view ${index + 1}` : `Gallery image ${index + 1}`;
      img.loading = 'eager';
      img.decoding = 'async';

      slide.appendChild(img);
      fragment.appendChild(slide);
    });

    modalTrack.appendChild(fragment);
  }

  function preloadNeighbors() {
    const next = currentImageIndex + 1;
    const prev = currentImageIndex - 1;
    if (images[next]) new Image().src = images[next];
    if (images[prev]) new Image().src = images[prev];
  }

  function render({ animate = true } = {}) {
    updateTitle();
    updateCounter();
    setButtonsDisabled();
    updateTrackTransform({ animate });
    preloadNeighbors();
  }

  function openLightbox({ title = '', imgs = [], startIndex = 0 } = {}) {
    if (!modal) return;

    lastFocusedEl = document.activeElement instanceof HTMLElement ? document.activeElement : null;

    currentProjectTitle = title || '';
    images = Array.isArray(imgs) ? imgs.filter(Boolean) : [];
    currentImageIndex = clampIndex(Number(startIndex) || 0);

    buildSlides();

    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    render({ animate: false });

    if (modalClose instanceof HTMLElement) modalClose.focus();
  }

  function closeLightbox() {
    if (!modal) return;

    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';

    currentProjectTitle = '';
    images = [];
    currentImageIndex = 0;

    if (modalTrack instanceof HTMLElement) modalTrack.innerHTML = '';

    if (lastFocusedEl instanceof HTMLElement) lastFocusedEl.focus();
    lastFocusedEl = null;
  }

  function goTo(index) {
    currentImageIndex = clampIndex(index);
    render({ animate: true });
  }

  function goPrev() {
    if (currentImageIndex > 0) goTo(currentImageIndex - 1);
  }

  function goNext() {
    if (currentImageIndex < images.length - 1) goTo(currentImageIndex + 1);
  }

  // Open modal when gallery button clicked (event delegation)
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (!(target instanceof Element)) return;

    const btn = target.closest('[data-lightbox-open]');
    if (!(btn instanceof HTMLElement)) return;

    e.preventDefault();

    const title = btn.getAttribute('data-title') || '';
    const imagesData = btn.getAttribute('data-images');
    const startIndex = btn.getAttribute('data-start-index') || 0;

    if (!imagesData) return;

    try {
      const imgs = JSON.parse(imagesData);
      openLightbox({ title, imgs, startIndex });
    } catch (err) {
      console.error('Error parsing gallery data', err);
    }
  });

  if (modalClose) modalClose.addEventListener('click', closeLightbox);
  if (modalPrev) modalPrev.addEventListener('click', goPrev);
  if (modalNext) modalNext.addEventListener('click', goNext);

  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeLightbox();
    });
  }

  document.addEventListener('keydown', (e) => {
    if (!isOpen()) return;

    if (e.key === 'Escape') {
      closeLightbox();
    } else if (e.key === 'ArrowLeft') {
      goPrev();
    } else if (e.key === 'ArrowRight') {
      goNext();
    }
  });

  // Touch swipe support
  (function attachSwipe() {
    if (!modal) return;

    const gallery = document.querySelector('#projectLightbox .modal-gallery');
    if (!(gallery instanceof HTMLElement)) return;

    let startX = 0;
    let startY = 0;
    let dragging = false;

    gallery.addEventListener(
      'touchstart',
      (e) => {
        if (!isOpen()) return;
        const touch = e.touches && e.touches[0];
        if (!touch) return;

        startX = touch.clientX;
        startY = touch.clientY;
        dragging = true;
      },
      { passive: true }
    );

    gallery.addEventListener(
      'touchend',
      (e) => {
        if (!isOpen() || !dragging) return;

        dragging = false;
        const touch = e.changedTouches && e.changedTouches[0];
        if (!touch) return;

        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;

        // Ignore vertical scroll gestures
        if (Math.abs(dy) > Math.abs(dx)) return;

        const threshold = 40;
        if (dx > threshold) {
          goPrev();
        } else if (dx < -threshold) {
          goNext();
        }
      },
      { passive: true }
    );
  })();
</script>
